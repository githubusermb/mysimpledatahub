# Entity Diagrams - MySimpleDataHub

## Table of Contents
1. [collections_data_tbl Table (Iceberg)](#collections_data_tbl-table-iceberg)
2. [Series-Specific Views](#series-specific-views)
3. [Data Transformation Flow](#data-transformation-flow)
4. [Relationship Diagram](#relationship-diagram)

---

## collections_data_tbl Table (Iceberg)

### Table Structure

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TABLE: collections_data_tbl                                             â”‚
â”‚  TYPE: Apache Iceberg Table (Format Version 2)                              â”‚
â”‚  LOCATION: s3://iceberg-data-bucket/iceberg-data/collections_data_tbl/   â”‚
â”‚  PARTITIONED BY: seriesid, ingest_timestamp                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Column Name     â”‚  Data Type   â”‚  Nullable    â”‚  Description                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  seriesid        â”‚  STRING      â”‚  NO          â”‚  Series identifier          â”‚
â”‚                  â”‚              â”‚              â”‚  (e.g., 'fry9c', 'fry15')   â”‚
â”‚                  â”‚              â”‚              â”‚  ğŸ”‘ PARTITION KEY           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  aod             â”‚  STRING      â”‚  YES         â”‚  As-of-date                 â”‚
â”‚                  â”‚              â”‚              â”‚  (reporting date)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  rssdid          â”‚  STRING      â”‚  YES         â”‚  RSSD identifier            â”‚
â”‚                  â”‚              â”‚              â”‚  (institution ID)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  submissionts    â”‚  STRING      â”‚  YES         â”‚  Submission timestamp       â”‚
â”‚                  â”‚              â”‚              â”‚  (when data was submitted)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  key             â”‚  STRING      â”‚  NO          â”‚  Data point key/field name  â”‚
â”‚                  â”‚              â”‚              â”‚  (e.g., 'RCON2170')         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  value           â”‚  STRING      â”‚  YES         â”‚  Data point value           â”‚
â”‚                  â”‚              â”‚              â”‚  (actual data)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ingest_timestampâ”‚  STRING      â”‚  NO          â”‚  Ingestion timestamp        â”‚
â”‚                  â”‚              â”‚              â”‚  (extracted from S3 path)   â”‚
â”‚                  â”‚              â”‚              â”‚  ğŸ”‘ PARTITION KEY           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Sample Data

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ seriesid â”‚    aod     â”‚ rssdid  â”‚ submissionts â”‚    key    â”‚ value  â”‚ ingest_timestampâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ fry9c    â”‚ 2024-03-31 â”‚ 123456  â”‚ 1711900800   â”‚ RCON2170  â”‚ 50000  â”‚ 1770609249      â”‚
â”‚ fry9c    â”‚ 2024-03-31 â”‚ 123456  â”‚ 1711900800   â”‚ RCON0010  â”‚ 25000  â”‚ 1770609249      â”‚
â”‚ fry9c    â”‚ 2024-03-31 â”‚ 123456  â”‚ 1711900800   â”‚ RCON2200  â”‚ 75000  â”‚ 1770609249      â”‚
â”‚ fry15    â”‚ 2024-03-31 â”‚ 789012  â”‚ 1711900800   â”‚ RCON3210  â”‚ 100000 â”‚ 1770609249      â”‚
â”‚ fry15    â”‚ 2024-03-31 â”‚ 789012  â”‚ 1711900800   â”‚ RCON3220  â”‚ 150000 â”‚ 1770609249      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Physical Storage Layout

```
s3://iceberg-data-bucket/iceberg-data/collections_data_tbl/
â”‚
â”œâ”€â”€ metadata/
â”‚   â”œâ”€â”€ v1.metadata.json              # Iceberg metadata (schema, partitions)
â”‚   â”œâ”€â”€ v2.metadata.json              # Updated metadata
â”‚   â”œâ”€â”€ snap-1234567890.avro          # Snapshot manifest
â”‚   â””â”€â”€ version-hint.text             # Current version pointer
â”‚
â””â”€â”€ data/
    â”œâ”€â”€ seriesid=fry9c/
    â”‚   â”œâ”€â”€ ingest_timestamp=1770609249/
    â”‚   â”‚   â”œâ”€â”€ 00000-0-data-001.parquet
    â”‚   â”‚   â”œâ”€â”€ 00001-0-data-002.parquet
    â”‚   â”‚   â””â”€â”€ ...
    â”‚   â””â”€â”€ ingest_timestamp=1770609350/
    â”‚       â””â”€â”€ 00000-0-data-001.parquet
    â”‚
    â””â”€â”€ seriesid=fry15/
        â””â”€â”€ ingest_timestamp=1770609249/
            â”œâ”€â”€ 00000-0-data-001.parquet
            â””â”€â”€ 00001-0-data-002.parquet
```

### Iceberg Table Properties

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Iceberg Configuration                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  format-version: 2                                               â”‚
â”‚  table_type: ICEBERG                                             â”‚
â”‚  storage_handler: org.apache.iceberg.mr.hive.HiveIcebergStorage  â”‚
â”‚  serialization.format: 1                                         â”‚
â”‚  storage.location.provider: org.apache.iceberg.aws.s3.S3FileIO  â”‚
â”‚  GOVERNED: true (Lake Formation managed)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Partitioning Strategy

```
Partition Keys: seriesid, ingest_timestamp

Benefits:
âœ… Query pruning by seriesid (filter specific series)
âœ… Query pruning by ingest_timestamp (filter by ingestion time)
âœ… Efficient data organization
âœ… Faster aggregations per series
âœ… Time-based data lifecycle management

Example Query Optimization:
  SELECT * FROM collections_data_tbl 
  WHERE seriesid = 'fry9c' 
    AND ingest_timestamp = '1770609249'
  
  â†’ Only reads: data/seriesid=fry9c/ingest_timestamp=1770609249/*.parquet
  â†’ Skips all other partitions
```

---

## Series-Specific Views

### View Naming Convention

```
<seriesid>_report_view

Examples:
  â€¢ fry9c_report_view
  â€¢ fry15_report_view
  â€¢ <any_seriesid>_report_view
```

### View Structure: fry9c_report_view

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  VIEW: fry9c_report_view                                                     â”‚
â”‚  TYPE: PROTECTED MULTI DIALECT VIEW                                          â”‚
â”‚  BASE TABLE: collections_data_tbl                                        â”‚
â”‚  FILTER: WHERE seriesid = 'fry9c'                                            â”‚
â”‚  TRANSFORMATION: Pivot (key â†’ columns)                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Column Name     â”‚  Data Type   â”‚  Nullable    â”‚  Description                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  seriesid        â”‚  STRING      â”‚  NO          â”‚  Series identifier          â”‚
â”‚                  â”‚              â”‚              â”‚  (always 'fry9c')           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  aod             â”‚  STRING      â”‚  YES         â”‚  As-of-date                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  rssdid          â”‚  STRING      â”‚  YES         â”‚  RSSD identifier            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  submissionts    â”‚  STRING      â”‚  YES         â”‚  Submission timestamp       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  RCON2170        â”‚  STRING      â”‚  YES         â”‚  Pivoted column from key    â”‚
â”‚                  â”‚              â”‚              â”‚  (dynamic - from data)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  RCON0010        â”‚  STRING      â”‚  YES         â”‚  Pivoted column from key    â”‚
â”‚                  â”‚              â”‚              â”‚  (dynamic - from data)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  RCON2200        â”‚  STRING      â”‚  YES         â”‚  Pivoted column from key    â”‚
â”‚                  â”‚              â”‚              â”‚  (dynamic - from data)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ...             â”‚  STRING      â”‚  YES         â”‚  Additional pivoted columns â”‚
â”‚                  â”‚              â”‚              â”‚  (one per distinct key)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Sample Data: fry9c_report_view

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ seriesid â”‚    aod     â”‚ rssdid  â”‚ submissionts â”‚ RCON2170 â”‚ RCON0010 â”‚ RCON2200 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ fry9c    â”‚ 2024-03-31 â”‚ 123456  â”‚ 1711900800   â”‚ 50000    â”‚ 25000    â”‚ 75000    â”‚
â”‚ fry9c    â”‚ 2024-06-30 â”‚ 123456  â”‚ 1719792000   â”‚ 52000    â”‚ 26000    â”‚ 78000    â”‚
â”‚ fry9c    â”‚ 2024-03-31 â”‚ 789012  â”‚ 1711900800   â”‚ 45000    â”‚ 22000    â”‚ 67000    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### View SQL Definition

#### Spark SQL Dialect (Default)
```sql
CREATE PROTECTED MULTI DIALECT VIEW glue_catalog.collections_db.fry9c_report_view
SECURITY DEFINER
AS
SELECT 
    seriesid,
    aod,
    rssdid,
    submissionts,
    MAX(CASE WHEN key = 'RCON2170' THEN value ELSE NULL END) AS `RCON2170`,
    MAX(CASE WHEN key = 'RCON0010' THEN value ELSE NULL END) AS `RCON0010`,
    MAX(CASE WHEN key = 'RCON2200' THEN value ELSE NULL END) AS `RCON2200`
    -- ... additional columns for each distinct key
FROM 
    glue_catalog.collections_db.collections_data_tbl
WHERE
    seriesid = 'fry9c'
GROUP BY 
    seriesid, aod, rssdid, submissionts
```

#### Athena Dialect (Added via ALTER VIEW)
```sql
ALTER VIEW collections_db.fry9c_report_view ADD DIALECT AS
SELECT 
    seriesid,
    aod,
    rssdid,
    submissionts,
    MAX(CASE WHEN key = 'RCON2170' THEN value ELSE NULL END) AS "RCON2170",
    MAX(CASE WHEN key = 'RCON0010' THEN value ELSE NULL END) AS "RCON0010",
    MAX(CASE WHEN key = 'RCON2200' THEN value ELSE NULL END) AS "RCON2200"
    -- ... additional columns for each distinct key
FROM 
    collections_db.collections_data_tbl
WHERE
    seriesid = 'fry9c'
GROUP BY 
    seriesid, aod, rssdid, submissionts
```

### View Structure: fry15_report_view

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  VIEW: fry15_report_view                                                     â”‚
â”‚  TYPE: PROTECTED MULTI DIALECT VIEW                                          â”‚
â”‚  BASE TABLE: collections_data_tbl                                        â”‚
â”‚  FILTER: WHERE seriesid = 'fry15'                                            â”‚
â”‚  TRANSFORMATION: Pivot (key â†’ columns)                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Column Name     â”‚  Data Type   â”‚  Nullable    â”‚  Description                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  seriesid        â”‚  STRING      â”‚  NO          â”‚  Series identifier          â”‚
â”‚                  â”‚              â”‚              â”‚  (always 'fry15')           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  aod             â”‚  STRING      â”‚  YES         â”‚  As-of-date                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  rssdid          â”‚  STRING      â”‚  YES         â”‚  RSSD identifier            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  submissionts    â”‚  STRING      â”‚  YES         â”‚  Submission timestamp       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  RCON3210        â”‚  STRING      â”‚  YES         â”‚  Pivoted column from key    â”‚
â”‚                  â”‚              â”‚              â”‚  (dynamic - from data)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  RCON3220        â”‚  STRING      â”‚  YES         â”‚  Pivoted column from key    â”‚
â”‚                  â”‚              â”‚              â”‚  (dynamic - from data)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ...             â”‚  STRING      â”‚  YES         â”‚  Additional pivoted columns â”‚
â”‚                  â”‚              â”‚              â”‚  (one per distinct key)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Sample Data: fry15_report_view

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ seriesid â”‚    aod     â”‚ rssdid  â”‚ submissionts â”‚ RCON3210 â”‚ RCON3220 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ fry15    â”‚ 2024-03-31 â”‚ 789012  â”‚ 1711900800   â”‚ 100000   â”‚ 150000   â”‚
â”‚ fry15    â”‚ 2024-06-30 â”‚ 789012  â”‚ 1719792000   â”‚ 105000   â”‚ 155000   â”‚
â”‚ fry15    â”‚ 2024-03-31 â”‚ 456789  â”‚ 1711900800   â”‚ 95000    â”‚ 145000   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Multi-Dialect View Properties

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  View Configuration                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ViewType: PROTECTED MULTI DIALECT VIEW                          â”‚
â”‚  Security: DEFINER (runs with creator's permissions)             â”‚
â”‚  Dialects:                                                       â”‚
â”‚    â€¢ Default: Spark SQL (for Glue Spark)                        â”‚
â”‚    â€¢ Athena: Presto SQL (for Amazon Athena)                     â”‚
â”‚  GOVERNED: true (Lake Formation managed)                         â”‚
â”‚  IsMultiDialectView: true                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Transformation Flow

### From Narrow to Wide Format

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 1: Source CSV (Narrow Format)                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

seriesid,aod,rssdid,submissionts,key,value
fry9c,2024-03-31,123456,1711900800,RCON2170,50000
fry9c,2024-03-31,123456,1711900800,RCON0010,25000
fry9c,2024-03-31,123456,1711900800,RCON2200,75000

                            â†“ CSV to Iceberg Conversion
                            â†“ (glue_csv_to_iceberg.py)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 2: collections_data_tbl Table (Narrow Format - Iceberg)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ seriesid â”‚    aod     â”‚ rssdid  â”‚ submissionts â”‚    key    â”‚ value  â”‚ ingest_timestampâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ fry9c    â”‚ 2024-03-31 â”‚ 123456  â”‚ 1711900800   â”‚ RCON2170  â”‚ 50000  â”‚ 1770609249      â”‚
â”‚ fry9c    â”‚ 2024-03-31 â”‚ 123456  â”‚ 1711900800   â”‚ RCON0010  â”‚ 25000  â”‚ 1770609249      â”‚
â”‚ fry9c    â”‚ 2024-03-31 â”‚ 123456  â”‚ 1711900800   â”‚ RCON2200  â”‚ 75000  â”‚ 1770609249      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                            â†“ Pivot Transformation
                            â†“ (glue_create_views_dual_engine.py)
                            â†“ GROUP BY seriesid, aod, rssdid, submissionts
                            â†“ MAX(CASE WHEN key = 'X' THEN value END) AS X

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 3: fry9c_report_view (Wide Format - View)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ seriesid â”‚    aod     â”‚ rssdid  â”‚ submissionts â”‚ RCON2170 â”‚ RCON0010 â”‚ RCON2200 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ fry9c    â”‚ 2024-03-31 â”‚ 123456  â”‚ 1711900800   â”‚ 50000    â”‚ 25000    â”‚ 75000    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Pivot Logic Explanation

```
For each unique combination of (seriesid, aod, rssdid, submissionts):
  
  1. Filter rows: WHERE seriesid = 'fry9c'
  
  2. For each distinct key value in the filtered data:
     Create a column: MAX(CASE WHEN key = '<key_value>' THEN value ELSE NULL END)
  
  3. Group by: seriesid, aod, rssdid, submissionts
  
  4. Result: One row per unique combination with pivoted columns

Example:
  Input (3 rows):
    (fry9c, 2024-03-31, 123456, 1711900800, RCON2170, 50000)
    (fry9c, 2024-03-31, 123456, 1711900800, RCON0010, 25000)
    (fry9c, 2024-03-31, 123456, 1711900800, RCON2200, 75000)
  
  Output (1 row):
    (fry9c, 2024-03-31, 123456, 1711900800, 50000, 25000, 75000)
```

---

## Relationship Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Entity Relationship Diagram                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     CSV Source Files         â”‚
                    â”‚  (S3 Raw Data Bucket)        â”‚
                    â”‚                              â”‚
                    â”‚  â€¢ mdrm_data_<ts>.csv        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â”‚ Ingestion
                                   â”‚ (csv-to-iceberg-ingestion)
                                   â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     collections_data_tbl â”‚
                    â”‚  (Iceberg Table)             â”‚
                    â”‚                              â”‚
                    â”‚  PK: (seriesid, aod,         â”‚
                    â”‚       rssdid, submissionts,  â”‚
                    â”‚       key, ingest_timestamp) â”‚
                    â”‚                              â”‚
                    â”‚  Partitions:                 â”‚
                    â”‚  â€¢ seriesid                  â”‚
                    â”‚  â€¢ ingest_timestamp          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â”‚ View Creation
                                   â”‚ (create-views-dual-engine)
                                   â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                              â”‚
                    â–¼                              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  fry9c_report_view        â”‚  â”‚  fry15_report_view        â”‚
    â”‚  (Multi-Dialect View)     â”‚  â”‚  (Multi-Dialect View)     â”‚
    â”‚                           â”‚  â”‚                           â”‚
    â”‚  Filter: seriesid='fry9c' â”‚  â”‚  Filter: seriesid='fry15' â”‚
    â”‚  Transform: Pivot         â”‚  â”‚  Transform: Pivot         â”‚
    â”‚                           â”‚  â”‚                           â”‚
    â”‚  Columns:                 â”‚  â”‚  Columns:                 â”‚
    â”‚  â€¢ seriesid               â”‚  â”‚  â€¢ seriesid               â”‚
    â”‚  â€¢ aod                    â”‚  â”‚  â€¢ aod                    â”‚
    â”‚  â€¢ rssdid                 â”‚  â”‚  â€¢ rssdid                 â”‚
    â”‚  â€¢ submissionts           â”‚  â”‚  â€¢ submissionts           â”‚
    â”‚  â€¢ RCON2170 (pivoted)     â”‚  â”‚  â€¢ RCON3210 (pivoted)     â”‚
    â”‚  â€¢ RCON0010 (pivoted)     â”‚  â”‚  â€¢ RCON3220 (pivoted)     â”‚
    â”‚  â€¢ RCON2200 (pivoted)     â”‚  â”‚  â€¢ ... (pivoted)          â”‚
    â”‚  â€¢ ... (pivoted)          â”‚  â”‚                           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                              â”‚
                    â”‚                              â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â”‚ Query Access
                                   â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                              â”‚
                    â–¼                              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Amazon Athena    â”‚          â”‚  AWS Glue Spark   â”‚
        â”‚  (Presto SQL)     â”‚          â”‚  (PySpark SQL)    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Cardinality

```
CSV Files (1:N) â†’ collections_data_tbl Table
  â€¢ One CSV file can contain multiple rows
  â€¢ Multiple CSV files can be ingested into one table

collections_data_tbl Table (1:N) â†’ Series Views
  â€¢ One table contains data for multiple series
  â€¢ Each series gets its own view

Series View (1:1) â†’ seriesid
  â€¢ Each view represents exactly one seriesid
  â€¢ One seriesid has exactly one view

collections_data_tbl Row (N:1) â†’ View Row
  â€¢ Multiple collections_data_tbl rows (different keys) 
    â†’ Pivot into one view row
  â€¢ Grouped by: seriesid, aod, rssdid, submissionts
```

### Data Lineage

```
Source â†’ Staging â†’ Production â†’ Consumption

CSV File
  â””â”€> S3 Raw Data Bucket (collections-data/ingest_ts=<ts>/)
      â””â”€> Glue Job: csv-to-iceberg-ingestion
          â””â”€> collections_data_tbl Table (iceberg-data/collections_data_tbl/)
              â””â”€> Glue Job: create-views-dual-engine
                  â””â”€> <seriesid>_report_view Views
                      â”œâ”€> Athena Queries
                      â””â”€> Glue Spark Queries
```

---

## Query Examples

### Query collections_data_tbl Table

```sql
-- Athena
SELECT * FROM collections_db.collections_data_tbl 
WHERE seriesid = 'fry9c' 
  AND ingest_timestamp = '1770609249'
LIMIT 10;

-- Glue Spark
spark.sql("""
    SELECT * FROM glue_catalog.collections_db.collections_data_tbl 
    WHERE seriesid = 'fry9c' 
      AND ingest_timestamp = '1770609249'
    LIMIT 10
""").show()
```

### Query Series-Specific Views

```sql
-- Athena
SELECT * FROM collections_db.fry9c_report_view
WHERE aod = '2024-03-31'
LIMIT 10;

-- Glue Spark
spark.sql("""
    SELECT * FROM glue_catalog.collections_db.fry9c_report_view
    WHERE aod = '2024-03-31'
    LIMIT 10
""").show()
```

### Join Multiple Views

```sql
-- Athena
SELECT 
    f9.seriesid AS fry9c_series,
    f9.aod,
    f9.rssdid,
    f9.RCON2170 AS fry9c_value,
    f15.RCON3210 AS fry15_value
FROM collections_db.fry9c_report_view f9
LEFT JOIN collections_db.fry15_report_view f15
  ON f9.rssdid = f15.rssdid
  AND f9.aod = f15.aod
WHERE f9.aod = '2024-03-31';
```

---

**Version**: 1.0  
**Last Updated**: February 11, 2026  
**Status**: Production Ready âœ…


---

## Pivoted View Example for Collections Data

### Overview

The collections_data_tbl table stores data in a narrow (EAV) format with columns:
- `seriesid`, `aod`, `rssdid`, `submission_ts` (grouping keys)
- `item_mdrm`, `item_desc`, `item_value` (item data)
- `context_level1_mdrm`, `context_level1_desc`, `context_level1_value` (context data)
- `context_level2_mdrm`, `context_level2_desc`, `context_level2_value` (additional context)
- `context_level3_mdrm`, `context_level3_desc`, `context_level3_value` (additional context)
- `ingest_timestamp` (partition key - extracted from S3 path)

### Pivoted View Structure

When creating a pivoted view, each distinct `item_mdrm` value becomes a column containing the corresponding `item_value`.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  VIEW: fry9c_pivoted_view                                                    â”‚
â”‚  TYPE: PROTECTED MULTI DIALECT VIEW                                          â”‚
â”‚  BASE TABLE: collections_data_tbl                                            â”‚
â”‚  FILTER: WHERE seriesid = 'FRY9C'                                            â”‚
â”‚  TRANSFORMATION: Pivot (item_mdrm â†’ columns with item_value)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Column Name     â”‚  Data Type   â”‚  Nullable    â”‚  Description                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  seriesid        â”‚  STRING      â”‚  NO          â”‚  Series identifier          â”‚
â”‚                  â”‚              â”‚              â”‚  (always 'FRY9C')           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  aod             â”‚  STRING      â”‚  YES         â”‚  As-of-date (20230131)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  rssdid          â”‚  STRING      â”‚  YES         â”‚  RSSD identifier (1234567)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  submission_ts   â”‚  STRING      â”‚  YES         â”‚  Submission timestamp       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  BHCK4435        â”‚  STRING      â”‚  YES         â”‚  Pivoted: item_value for    â”‚
â”‚                  â”‚              â”‚              â”‚  item_mdrm='BHCK4435'       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  BHCK4436        â”‚  STRING      â”‚  YES         â”‚  Pivoted: item_value for    â”‚
â”‚                  â”‚              â”‚              â”‚  item_mdrm='BHCK4436'       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  BHCKF821        â”‚  STRING      â”‚  YES         â”‚  Pivoted: item_value for    â”‚
â”‚                  â”‚              â”‚              â”‚  item_mdrm='BHCKF821'       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ...             â”‚  STRING      â”‚  YES         â”‚  Additional pivoted columns â”‚
â”‚                  â”‚              â”‚              â”‚  (one per distinct item_mdrm)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Handling Context Levels in Pivoted Views

#### Option 1: Exclude Context Columns (Recommended for Simple Reports)

**Use Case:** When you only need the item values for reporting and analysis.

**Approach:** Pivot only `item_mdrm` â†’ `item_value`, exclude all context columns.

```sql
CREATE PROTECTED MULTI DIALECT VIEW glue_catalog.collections_db.fry9c_pivoted_view
SECURITY DEFINER
AS
SELECT 
    seriesid,
    aod,
    rssdid,
    submission_ts,
    MAX(CASE WHEN item_mdrm = 'BHCK4435' THEN item_value ELSE NULL END) AS `BHCK4435`,
    MAX(CASE WHEN item_mdrm = 'BHCK4436' THEN item_value ELSE NULL END) AS `BHCK4436`,
    MAX(CASE WHEN item_mdrm = 'BHCKF821' THEN item_value ELSE NULL END) AS `BHCKF821`,
    MAX(CASE WHEN item_mdrm = 'BHCK4059' THEN item_value ELSE NULL END) AS `BHCK4059`
    -- ... additional columns for each distinct item_mdrm
FROM 
    glue_catalog.collections_db.collections_data_tbl
WHERE
    seriesid = 'FRY9C'
GROUP BY 
    seriesid, aod, rssdid, submission_ts
```

**Sample Output:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ seriesid â”‚   aod    â”‚ rssdid  â”‚ submission_ts â”‚ BHCK4435 â”‚ BHCK4436 â”‚ BHCKF821 â”‚ BHCK4059 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ FRY9C    â”‚ 20230131 â”‚ 1234567 â”‚ 1740000002    â”‚ 6382456  â”‚ 1989171  â”‚ 8709917  â”‚ 1654013  â”‚
â”‚ FRY9C    â”‚ 20231231 â”‚ 2345678 â”‚ 1740000002    â”‚ 5123456  â”‚ 2345678  â”‚ 7890123  â”‚ 1234567  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Option 2: Include Context as Separate Columns (For Detailed Analysis)

**Use Case:** When you need both item values and their context information.

**Approach:** Add context columns as additional grouping keys or as separate pivoted columns.

```sql
CREATE PROTECTED MULTI DIALECT VIEW glue_catalog.collections_db.fr2004a_pivoted_with_context_view
SECURITY DEFINER
AS
SELECT 
    seriesid,
    aod,
    rssdid,
    submission_ts,
    -- Include context as grouping columns
    MAX(context_level1_mdrm) AS context_level1_mdrm,
    MAX(context_level1_desc) AS context_level1_desc,
    MAX(context_level1_value) AS context_level1_value,
    -- Pivot item values
    MAX(CASE WHEN item_mdrm = 'GSWAM438' THEN item_value ELSE NULL END) AS `GSWAM438`,
    MAX(CASE WHEN item_mdrm = 'GSWAN749' THEN item_value ELSE NULL END) AS `GSWAN749`,
    MAX(CASE WHEN item_mdrm = 'GSWAM440' THEN item_value ELSE NULL END) AS `GSWAM440`
    -- ... additional columns for each distinct item_mdrm
FROM 
    glue_catalog.collections_db.collections_data_tbl
WHERE
    seriesid = 'FR2004A'
GROUP BY 
    seriesid, aod, rssdid, submission_ts
```

**Sample Output:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ seriesid â”‚   aod    â”‚ rssdid  â”‚ submission_ts â”‚ context_level1_  â”‚ context_level1_   â”‚ context_level1_    â”‚ GSWAM438 â”‚ GSWAN749 â”‚
â”‚          â”‚          â”‚         â”‚               â”‚ mdrm             â”‚ desc              â”‚ value              â”‚          â”‚          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ FR2004A  â”‚ 20241231 â”‚ 2345678 â”‚ 1740000002    â”‚ GSWA0001         â”‚ Long  1           â”‚ 1                  â”‚ 244360   â”‚ 8671856  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Option 3: Composite Column Names (For Complex Hierarchies)

**Use Case:** When context levels create different dimensions and you need to distinguish values by context.

**Approach:** Create column names that combine `item_mdrm` with `context_level1_value` (or other context).

```sql
CREATE PROTECTED MULTI DIALECT VIEW glue_catalog.collections_db.fr2004a_pivoted_composite_view
SECURITY DEFINER
AS
SELECT 
    seriesid,
    aod,
    rssdid,
    submission_ts,
    -- Create composite columns: item_mdrm + context
    MAX(CASE WHEN item_mdrm = 'GSWAM438' AND context_level1_value = '1' THEN item_value ELSE NULL END) AS `GSWAM438_CTX1`,
    MAX(CASE WHEN item_mdrm = 'GSWAM438' AND context_level1_value = '2' THEN item_value ELSE NULL END) AS `GSWAM438_CTX2`,
    MAX(CASE WHEN item_mdrm = 'GSWAN749' AND context_level1_value = '1' THEN item_value ELSE NULL END) AS `GSWAN749_CTX1`,
    MAX(CASE WHEN item_mdrm = 'GSWAN749' AND context_level1_value = '2' THEN item_value ELSE NULL END) AS `GSWAN749_CTX2`
    -- ... additional columns for each distinct item_mdrm + context combination
FROM 
    glue_catalog.collections_db.collections_data_tbl
WHERE
    seriesid = 'FR2004A'
GROUP BY 
    seriesid, aod, rssdid, submission_ts
```

### Recommendations

1. **Exclude item_desc from pivoted columns**: The `item_desc` is descriptive metadata that doesn't change. Store it in a separate reference table or exclude it from the view to keep the view clean.

2. **Context handling strategy**:
   - **Simple series (FRY9C, FRY15)**: Use Option 1 - exclude context columns since they're mostly empty
   - **Complex series (FR2004A)**: Use Option 2 - include context as separate columns for filtering and grouping
   - **Multi-dimensional data**: Use Option 3 - create composite column names when the same item_mdrm appears with different contexts

3. **Performance considerations**:
   - Pivoted views with many columns (1000+) may have slower query performance
   - Consider creating multiple views by category or subsection if you have too many item_mdrm values
   - Use partition pruning by including `seriesid` filter in WHERE clause

4. **Athena dialect**: When adding Athena dialect, use double quotes for column names instead of backticks:
   ```sql
   ALTER VIEW collections_db.fry9c_pivoted_view ADD DIALECT AS
   SELECT 
       seriesid,
       aod,
       rssdid,
       submission_ts,
       MAX(CASE WHEN item_mdrm = 'BHCK4435' THEN item_value ELSE NULL END) AS "BHCK4435",
       MAX(CASE WHEN item_mdrm = 'BHCK4436' THEN item_value ELSE NULL END) AS "BHCK4436"
       -- ...
   FROM collections_db.collections_data_tbl
   WHERE seriesid = 'FRY9C'
   GROUP BY seriesid, aod, rssdid, submission_ts
   ```

### Complete Example: FRY9C Pivoted View

```sql
-- Step 1: Create the protected multi-dialect view (Spark SQL)
CREATE PROTECTED MULTI DIALECT VIEW glue_catalog.collections_db.fry9c_pivoted_view
SECURITY DEFINER
AS
SELECT 
    seriesid,
    aod,
    rssdid,
    submission_ts,
    MAX(CASE WHEN item_mdrm = 'BHCK4435' THEN item_value ELSE NULL END) AS `BHCK4435`,
    MAX(CASE WHEN item_mdrm = 'BHCK4436' THEN item_value ELSE NULL END) AS `BHCK4436`,
    MAX(CASE WHEN item_mdrm = 'BHCKF821' THEN item_value ELSE NULL END) AS `BHCKF821`,
    MAX(CASE WHEN item_mdrm = 'BHCK4059' THEN item_value ELSE NULL END) AS `BHCK4059`,
    MAX(CASE WHEN item_mdrm = 'BHCK4065' THEN item_value ELSE NULL END) AS `BHCK4065`
    -- Add all other distinct item_mdrm values as columns
FROM 
    glue_catalog.collections_db.collections_data_tbl
WHERE
    seriesid = 'FRY9C'
GROUP BY 
    seriesid, aod, rssdid, submission_ts;

-- Step 2: Add Athena dialect
ALTER VIEW collections_db.fry9c_pivoted_view ADD DIALECT AS
SELECT 
    seriesid,
    aod,
    rssdid,
    submission_ts,
    MAX(CASE WHEN item_mdrm = 'BHCK4435' THEN item_value ELSE NULL END) AS "BHCK4435",
    MAX(CASE WHEN item_mdrm = 'BHCK4436' THEN item_value ELSE NULL END) AS "BHCK4436",
    MAX(CASE WHEN item_mdrm = 'BHCKF821' THEN item_value ELSE NULL END) AS "BHCKF821",
    MAX(CASE WHEN item_mdrm = 'BHCK4059' THEN item_value ELSE NULL END) AS "BHCK4059",
    MAX(CASE WHEN item_mdrm = 'BHCK4065' THEN item_value ELSE NULL END) AS "BHCK4065"
    -- Add all other distinct item_mdrm values as columns
FROM 
    collections_db.collections_data_tbl
WHERE
    seriesid = 'FRY9C'
GROUP BY 
    seriesid, aod, rssdid, submission_ts;
```

### Querying the Pivoted View

```sql
-- Query in Athena
SELECT 
    aod,
    rssdid,
    "BHCK4435" AS loans_residential,
    "BHCK4436" AS loans_other_real_estate,
    "BHCKF821" AS loans_other
FROM collections_db.fry9c_pivoted_view
WHERE aod = '20230131'
ORDER BY rssdid;

-- Query in Glue Spark
SELECT 
    aod,
    rssdid,
    `BHCK4435` AS loans_residential,
    `BHCK4436` AS loans_other_real_estate,
    `BHCKF821` AS loans_other
FROM glue_catalog.collections_db.fry9c_pivoted_view
WHERE aod = '20230131'
ORDER BY rssdid;
```


#### Option 4: Concatenated Context Pattern (Comprehensive Single-Column Approach)

**Use Case:** When you want to preserve all context information within each pivoted column value using a structured pattern.

**Approach:** Concatenate context levels with item_value using the pattern:
`<context_level1_mdrm>=<context_level1_value>:<context_level2_mdrm>=<context_level2_value>:<context_level3_mdrm>=<context_level3_value>:<item_value>`

If no context exists, store only the `item_value`.

**SQL Implementation:**

```sql
CREATE PROTECTED MULTI DIALECT VIEW glue_catalog.collections_db.fr2004a_pivoted_concat_view
SECURITY DEFINER
AS
SELECT 
    seriesid,
    aod,
    rssdid,
    submission_ts,
    MAX(CASE WHEN item_mdrm = 'GSWAM438' THEN 
        CASE 
            WHEN context_level1_mdrm IS NOT NULL AND context_level1_mdrm != '' THEN
                CONCAT(
                    COALESCE(context_level1_mdrm, ''), '=', COALESCE(context_level1_value, ''),
                    CASE WHEN context_level2_mdrm IS NOT NULL AND context_level2_mdrm != '' 
                         THEN CONCAT(':', context_level2_mdrm, '=', COALESCE(context_level2_value, ''))
                         ELSE '' END,
                    CASE WHEN context_level3_mdrm IS NOT NULL AND context_level3_mdrm != '' 
                         THEN CONCAT(':', context_level3_mdrm, '=', COALESCE(context_level3_value, ''))
                         ELSE '' END,
                    ':', item_value
                )
            ELSE item_value
        END
    ELSE NULL END) AS `GSWAM438`,
    
    MAX(CASE WHEN item_mdrm = 'GSWAN749' THEN 
        CASE 
            WHEN context_level1_mdrm IS NOT NULL AND context_level1_mdrm != '' THEN
                CONCAT(
                    COALESCE(context_level1_mdrm, ''), '=', COALESCE(context_level1_value, ''),
                    CASE WHEN context_level2_mdrm IS NOT NULL AND context_level2_mdrm != '' 
                         THEN CONCAT(':', context_level2_mdrm, '=', COALESCE(context_level2_value, ''))
                         ELSE '' END,
                    CASE WHEN context_level3_mdrm IS NOT NULL AND context_level3_mdrm != '' 
                         THEN CONCAT(':', context_level3_mdrm, '=', COALESCE(context_level3_value, ''))
                         ELSE '' END,
                    ':', item_value
                )
            ELSE item_value
        END
    ELSE NULL END) AS `GSWAN749`,
    
    MAX(CASE WHEN item_mdrm = 'GSWAM440' THEN 
        CASE 
            WHEN context_level1_mdrm IS NOT NULL AND context_level1_mdrm != '' THEN
                CONCAT(
                    COALESCE(context_level1_mdrm, ''), '=', COALESCE(context_level1_value, ''),
                    CASE WHEN context_level2_mdrm IS NOT NULL AND context_level2_mdrm != '' 
                         THEN CONCAT(':', context_level2_mdrm, '=', COALESCE(context_level2_value, ''))
                         ELSE '' END,
                    CASE WHEN context_level3_mdrm IS NOT NULL AND context_level3_mdrm != '' 
                         THEN CONCAT(':', context_level3_mdrm, '=', COALESCE(context_level3_value, ''))
                         ELSE '' END,
                    ':', item_value
                )
            ELSE item_value
        END
    ELSE NULL END) AS `GSWAM440`,
    
    MAX(CASE WHEN item_mdrm = 'GSWAM442' THEN 
        CASE 
            WHEN context_level1_mdrm IS NOT NULL AND context_level1_mdrm != '' THEN
                CONCAT(
                    COALESCE(context_level1_mdrm, ''), '=', COALESCE(context_level1_value, ''),
                    CASE WHEN context_level2_mdrm IS NOT NULL AND context_level2_mdrm != '' 
                         THEN CONCAT(':', context_level2_mdrm, '=', COALESCE(context_level2_value, ''))
                         ELSE '' END,
                    CASE WHEN context_level3_mdrm IS NOT NULL AND context_level3_mdrm != '' 
                         THEN CONCAT(':', context_level3_mdrm, '=', COALESCE(context_level3_value, ''))
                         ELSE '' END,
                    ':', item_value
                )
            ELSE item_value
        END
    ELSE NULL END) AS `GSWAM442`
    -- ... additional columns for each distinct item_mdrm
FROM 
    glue_catalog.collections_db.collections_data_tbl
WHERE
    seriesid = 'FR2004A'
GROUP BY 
    seriesid, aod, rssdid, submission_ts;
```

**Sample Output for FR2004A:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ seriesid â”‚   aod    â”‚ rssdid  â”‚ submission_ts â”‚      GSWAM438       â”‚      GSWAN749       â”‚      GSWAM440       â”‚      GSWAM442       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ FR2004A  â”‚ 20241231 â”‚ 2345678 â”‚ 1740000002    â”‚ GSWA0001=1:244360   â”‚ GSWA0001=1:8671856  â”‚ GSWA0001=1:9200484  â”‚ GSWA0001=1:7275289  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Detailed Breakdown:**

For the FR2004A series with context data:
- **Original row**: `FR2004A,20241231,2345678,1740000002,GSWAM438,1a Bills,244360,GSWA0001,Long  1,1,,,,,,`
- **Pivoted column value**: `GSWA0001=1:244360`
  - `GSWA0001` = context_level1_mdrm
  - `1` = context_level1_value
  - `244360` = item_value
  - No context_level2 or context_level3, so they're omitted

For series without context (like FRY9C):
- **Original row**: `FRY9C,20230131,1234567,1740000002,BHCK4435,(a) Loans secured by 1- 4 family residential properties,6382456,,,,,,,,,`
- **Pivoted column value**: `6382456`
  - Only item_value since all context fields are empty

**Complete Example View Structure:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  VIEW: fr2004a_pivoted_concat_view                                           â”‚
â”‚  TYPE: PROTECTED MULTI DIALECT VIEW                                          â”‚
â”‚  BASE TABLE: collections_data_tbl                                            â”‚
â”‚  FILTER: WHERE seriesid = 'FR2004A'                                          â”‚
â”‚  TRANSFORMATION: Pivot with concatenated context pattern                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Column Structure:
â”œâ”€â”€ seriesid (STRING) - Always 'FR2004A'
â”œâ”€â”€ aod (STRING) - As-of-date (e.g., '20241231')
â”œâ”€â”€ rssdid (STRING) - Institution ID (e.g., '2345678')
â”œâ”€â”€ submission_ts (STRING) - Submission timestamp
â”œâ”€â”€ GSWAM438 (STRING) - Value: "GSWA0001=1:244360"
â”œâ”€â”€ GSWAN749 (STRING) - Value: "GSWA0001=1:8671856"
â”œâ”€â”€ GSWAM440 (STRING) - Value: "GSWA0001=1:9200484"
â”œâ”€â”€ GSWAM442 (STRING) - Value: "GSWA0001=1:7275289"
â”œâ”€â”€ GSWAM444 (STRING) - Value: "GSWA0001=1:1188668"
â”œâ”€â”€ GSWAM446 (STRING) - Value: "GSWA0001=1:3157944"
â”œâ”€â”€ GSWAM448 (STRING) - Value: "GSWA0001=1:5327898"
â”œâ”€â”€ GSWALF56 (STRING) - Value: "GSWA0001=1:6957830"
â”œâ”€â”€ GSWALF58 (STRING) - Value: "GSWA0001=1:9486292"
â””â”€â”€ ... (additional item_mdrm columns)
```

**Parsing the Concatenated Values:**

To extract individual components from the concatenated pattern in downstream applications:

```sql
-- Extract item_value (last segment after final colon)
SELECT 
    seriesid,
    aod,
    rssdid,
    GSWAM438,
    -- Extract just the numeric value
    REGEXP_EXTRACT(GSWAM438, ':([0-9]+)$', 1) AS gswam438_value,
    -- Extract context_level1_mdrm
    REGEXP_EXTRACT(GSWAM438, '^([^=]+)=', 1) AS gswam438_context1_mdrm,
    -- Extract context_level1_value
    REGEXP_EXTRACT(GSWAM438, '^[^=]+=([^:]+)', 1) AS gswam438_context1_value
FROM collections_db.fr2004a_pivoted_concat_view
WHERE aod = '20241231';
```

**Advantages of Option 4:**

1. **Complete information preservation**: All context levels and values are retained in a single column
2. **Self-documenting**: The pattern makes it clear what each component represents
3. **Flexible parsing**: Can extract specific components using regex or string functions
4. **Backward compatible**: Works for both series with context (FR2004A) and without (FRY9C)
5. **Single view structure**: No need for separate views or additional context columns

**Disadvantages:**

1. **String parsing required**: Need to parse the concatenated string to use individual components
2. **Not directly sortable/filterable**: Can't directly filter by context values without parsing
3. **Slightly larger storage**: Storing context labels repeatedly increases data size
4. **Query complexity**: More complex queries when you need to filter by context

**When to Use Option 4:**

- When you need to preserve complete context information but want a simple column structure
- When downstream systems can handle string parsing
- When you want a single view that works for all series types
- When you need to export data to external systems that expect a flat structure

**Comparison with Other Options:**

| Aspect | Option 1 | Option 2 | Option 3 | Option 4 |
|--------|----------|----------|----------|----------|
| Context preservation | âŒ Lost | âœ… Separate cols | âœ… In col name | âœ… In col value |
| Query simplicity | âœ… Simple | âš ï¸ Moderate | âš ï¸ Moderate | âš ï¸ Needs parsing |
| Column count | âœ… Minimal | âš ï¸ More cols | âŒ Many cols | âœ… Minimal |
| Filtering by context | âŒ Not possible | âœ… Easy | âœ… Easy | âš ï¸ Needs parsing |
| Works for all series | âœ… Yes | âš ï¸ Varies | âš ï¸ Varies | âœ… Yes |
| Storage efficiency | âœ… Efficient | âš ï¸ Moderate | âš ï¸ Moderate | âš ï¸ Larger |

**Recommendation:** Use Option 4 when you need a universal view structure that preserves all information and can be easily exported or shared with external systems that expect a flat, wide format.
